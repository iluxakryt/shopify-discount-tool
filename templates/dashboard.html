<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Discount Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body {
            background-color: #0d1117;
            color: #f0f6fc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }

        .sidebar {
            background-color: #161b22;
            border-right: 1px solid #30363d;
            min-height: 100vh;
        }

        .nav-link {
            color: #8b949e !important;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 16px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background-color: #21262d;
            color: #58a6ff !important;
        }

        .nav-link.active {
            background-color: #1f6feb;
            color: #ffffff !important;
        }

        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(1, 4, 9, 0.8);
        }

        .card-header {
            background-color: #21262d;
            border-bottom: 1px solid #30363d;
            color: #f0f6fc;
            font-weight: 600;
            padding: 20px;
        }

        .card-body {
            padding: 24px;
        }

        .form-control,
        .form-select {
            background-color: #0d1117;
            border: 2px solid #30363d;
            color: #f0f6fc;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #0d1117;
            border-color: #1f6feb;
            color: #f0f6fc;
            box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
        }

        .form-control::placeholder {
            color: #6e7681;
        }

        .form-label {
            color: #f0f6fc;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-text {
            color: #8b949e;
            font-size: 12px;
            margin-top: 6px;
        }

        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: #238636;
            border-color: #238636;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            color: #58a6ff;
            border-color: #58a6ff;
            background-color: transparent;
        }

        .btn-outline-primary:hover {
            background-color: #58a6ff;
            border-color: #58a6ff;
            color: #ffffff;
        }

        .strategy-card {
            background-color: #21262d;
            border: 2px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: 100%;
            margin-bottom: 16px;
        }

        .strategy-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(88, 166, 255, 0.2);
        }

        .strategy-card.selected {
            border-color: #1f6feb;
            background-color: #0969da;
            color: #ffffff;
        }

        .strategy-card.selected .text-muted {
            color: #b6e3ff !important;
        }

        .strategy-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .strategy-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .strategy-description {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        .preview-section {
            background-color: #0d1117;
            border: 2px dashed #30363d;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .preview-title {
            color: #58a6ff;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 16px;
        }

        .price-before,
        .price-after {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .price-old {
            text-decoration: line-through;
            color: #8b949e;
            font-size: 18px;
        }

        .price-new {
            color: #238636;
            font-size: 24px;
            font-weight: 700;
        }

        .discount-badge {
            background-color: #1f6feb;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
        }

        .progress {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            height: 24px;
        }

        .progress-bar {
            background-color: #238636;
            border-radius: 8px;
            font-weight: 600;
        }

        .stat-box {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #f0f6fc;
        }

        .stat-label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .alert {
            border-radius: 8px;
            border: 1px solid;
            padding: 16px;
            margin: 16px 0;
        }

        .alert-success {
            background-color: rgba(35, 134, 54, 0.15);
            border-color: #238636;
            color: #7ee787;
        }

        .alert-danger {
            background-color: rgba(248, 81, 73, 0.15);
            border-color: #f85149;
            color: #ffa198;
        }

        .alert-info {
            background-color: rgba(88, 166, 255, 0.15);
            border-color: #58a6ff;
            color: #79c0ff;
        }

        .help-section {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .help-title {
            color: #58a6ff;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .help-content h6 {
            color: #f0f6fc;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .help-content ul {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .help-content li {
            color: #e6edf3;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .help-content strong {
            color: #58a6ff;
            font-weight: 600;
        }

        .example-box {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        h1, h2, h3, h4, h5, h6 {
            color: #f0f6fc;
        }

        .text-muted {
            color: #8b949e !important;
        }

        .sidebar-brand {
            padding: 24px 20px;
            border-bottom: 1px solid #30363d;
            text-align: center;
        }

        .brand-title {
            color: #58a6ff;
            font-size: 20px;
            font-weight: 800;
            margin: 0;
        }

        .brand-subtitle {
            color: #8b949e;
            font-size: 12px;
            margin-top: 4px;
        }

        .current-item {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            text-align: center;
            font-size: 14px;
            color: #8b949e;
        }

        .spinner-border-sm {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container-fluid" x-data="discountApp()">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="sidebar-brand">
                    <h4 class="brand-title">
                        <i class="fas fa-percentage me-2"></i>
                        Shopify
                    </h4>
                    <div class="brand-subtitle">Discount Manager</div>
                </div>
                
                <div class="py-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" 
                               :class="{ 'active': currentTab === 'main' }"
                               href="#" 
                               @click="currentTab = 'main'">
                                <i class="fas fa-home me-2"></i>
                                Головна
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"
                               :class="{ 'active': currentTab === 'help' }"
                               href="#" 
                               @click="currentTab = 'help'">
                                <i class="fas fa-book me-2"></i>
                                Інструкція
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
                
                <!-- Main Tab -->
                <div x-show="currentTab === 'main'">
                    <div class="py-4">
                        <h1 class="mb-4">
                            <i class="fas fa-tags me-3"></i>
                            Керування знижками товарів
                        </h1>
                        
                        <!-- Strategy Selection -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chess me-2"></i>
                                    Крок 1: Оберіть стратегію оновлення
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6 col-xl-3">
                                        <div class="strategy-card" 
                                             :class="{ 'selected': form.strategy === 'increase_compare_only' }"
                                             @click="selectStrategy('increase_compare_only')">
                                            <div class="strategy-icon text-success">
                                                <i class="fas fa-arrow-up"></i>
                                            </div>
                                            <div class="strategy-title">Збільшити знижку</div>
                                            <div class="strategy-description text-muted">
                                                Підвищити порівняльну ціну, залишивши реальну без змін
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="strategy-card"
                                             :class="{ 'selected': form.strategy === 'decrease_price_only' }"
                                             @click="selectStrategy('decrease_price_only')">
                                            <div class="strategy-icon text-info">
                                                <i class="fas fa-arrow-down"></i>
                                            </div>
                                            <div class="strategy-title">Зменшити ціну</div>
                                            <div class="strategy-description text-muted">
                                                Знизити реальну ціну товару для покупців
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="strategy-card"
                                             :class="{ 'selected': form.strategy === 'both_directions' }"
                                             @click="selectStrategy('both_directions')">
                                            <div class="strategy-icon text-warning">
                                                <i class="fas fa-exchange-alt"></i>
                                            </div>
                                            <div class="strategy-title">Обидві ціни</div>
                                            <div class="strategy-description text-muted">
                                                Змінити і реальну, і порівняльну ціну одночасно
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="strategy-card"
                                             :class="{ 'selected': form.strategy === 'set_discount_percentage' }"
                                             @click="selectStrategy('set_discount_percentage')">
                                            <div class="strategy-icon text-danger">
                                                <i class="fas fa-bullseye"></i>
                                            </div>
                                            <div class="strategy-title">Точна знижка</div>
                                            <div class="strategy-description text-muted">
                                                Встановити конкретний відсоток знижки
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Form -->
                        <div class="card mb-4" x-show="form.strategy" x-transition>
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-cogs me-2"></i>
                                    Крок 2: Налаштування параметрів
                                </h5>
                            </div>
                            <div class="card-body">
                                <form @submit.prevent="submitUpdate()">
                                    <div class="row">
                                        <!-- Left Column -->
                                        <div class="col-lg-6">
                                            <div class="mb-4" x-show="form.strategy !== 'set_discount_percentage'">
                                                <label class="form-label">
                                                    <i class="fas fa-percentage me-2"></i>
                                                    Значення зміни (%)
                                                </label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       x-model="form.value"
                                                       step="0.01" 
                                                       min="0" 
                                                       max="1000"
                                                       required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <span x-text="getHelpText()"></span>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4" x-show="form.strategy === 'set_discount_percentage'">
                                                <label class="form-label">
                                                    <i class="fas fa-bullseye me-2"></i>
                                                    Бажаний відсоток знижки (%)
                                                </label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       x-model="form.target_discount"
                                                       step="0.01" 
                                                       min="0" 
                                                       max="99"
                                                       required>
                                                <div class="form-text">
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    Наприклад: 25 для знижки 25%
                                                </div>
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label">
                                                    <i class="fas fa-filter me-2"></i>
                                                    Фільтр товарів
                                                </label>
                                                <select class="form-select" x-model="form.filter_type">
                                                    <option value="all">🌟 Всі товари в магазині</option>
                                                    <option value="product_type">🏷️ За типом товару</option>
                                                    <option value="vendor">🏭 За виробником/брендом</option>
                                                </select>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Оберіть які товари обробляти
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column -->
                                        <div class="col-lg-6">
                                            <div class="mb-4" x-show="form.filter_type !== 'all'">
                                                <label class="form-label">
                                                    <i class="fas fa-search me-2"></i>
                                                    Значення фільтру
                                                </label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       x-model="form.filter_value"
                                                       placeholder="Наприклад: T-Shirt або Nike">
                                                <div class="form-text">
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    Введіть точну назву типу товару або бренду
                                                </div>
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label">
                                                    <i class="fas fa-list-ol me-2"></i>
                                                    Обмеження кількості (опціонально)
                                                </label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       x-model="form.limit_products"
                                                       min="1"
                                                       placeholder="Залиште порожнім для всіх товарів">
                                                <div class="form-text">
                                                    <i class="fas fa-shield-alt me-1"></i>
                                                    Рекомендується 5-10 товарів для першого тесту
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-3 justify-content-center">
                                        <button type="button" 
                                                class="btn btn-outline-primary" 
                                                @click="showPreview()"
                                                :disabled="!isFormValid() || isProcessing">
                                            <i class="fas fa-eye me-2"></i>
                                            Показати приклад
                                        </button>
                                        <button type="submit" 
                                                class="btn btn-primary"
                                                :disabled="!isFormValid() || isProcessing">
                                            <span x-show="isProcessing" class="spinner-border spinner-border-sm me-2"></span>
                                            <i class="fas fa-rocket me-2" x-show="!isProcessing"></i>
                                            Застосувати зміни
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div x-show="preview" x-transition class="preview-section">
                            <div class="preview-title">
                                <i class="fas fa-eye me-2"></i>
                                Приклад зміни для товару
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="price-before">
                                        <h6 class="text-muted mb-3">ДО ЗМІН</h6>
                                        <div x-text="`${preview?.product_title || 'Товар'}`" class="mb-2 fw-bold"></div>
                                        <div class="mb-2">
                                            <span class="price-old" x-show="preview?.current_compare_at_price" 
                                                  x-text="`$${preview?.current_compare_at_price?.toFixed(2) || ''}`"></span>
                                        </div>
                                        <div class="price-new" x-text="`$${preview?.current_price?.toFixed(2) || ''}`"></div>
                                        <div class="discount-badge" 
                                             x-text="`${preview?.current_discount_percentage?.toFixed(1) || 0}% знижка`"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="price-after">
                                        <h6 class="text-success mb-3">ПІСЛЯ ЗМІН</h6>
                                        <div x-text="`${preview?.product_title || 'Товар'}`" class="mb-2 fw-bold"></div>
                                        <div class="mb-2">
                                            <span class="price-old" x-show="preview?.new_compare_at_price" 
                                                  x-text="`$${preview?.new_compare_at_price?.toFixed(2) || ''}`"></span>
                                        </div>
                                        <div class="price-new" x-text="`$${preview?.new_price?.toFixed(2) || ''}`"></div>
                                        <div class="discount-badge" 
                                             x-text="`${preview?.new_discount_percentage?.toFixed(1) || 0}% знижка`"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="stat-box">
                                        <div class="stat-icon text-info">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="stat-number" 
                                             x-text="`${(preview?.discount_change || 0) > 0 ? '+' : ''}${(preview?.discount_change || 0).toFixed(1)}%`"></div>
                                        <div class="stat-label">Зміна знижки</div>
                                    </div>
                                </div>
                                <div class="col-md-6" x-show="preview?.savings_amount && preview.savings_amount > 0">
                                    <div class="stat-box">
                                        <div class="stat-icon text-success">
                                            <i class="fas fa-piggy-bank"></i>
                                        </div>
                                        <div class="stat-number" x-text="`$${(preview?.savings_amount || 0).toFixed(2)}`"></div>
                                        <div class="stat-label">Економія покупця</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div x-show="taskProgress" x-transition class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tasks me-2"></i>
                                    Прогрес оновлення знижок
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="progress mb-4">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         :style="`width: ${taskProgress?.percentage || 0}%`"
                                         x-text="`${taskProgress?.percentage || 0}%`">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="stat-box">
                                            <div class="stat-icon text-primary">
                                                <i class="fas fa-tasks"></i>
                                            </div>
                                            <div class="stat-number" x-text="`${taskProgress?.current || 0}/${taskProgress?.total || 0}`"></div>
                                            <div class="stat-label">Оброблено товарів</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-box">
                                            <div class="stat-icon text-success">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                            <div class="stat-number" x-text="taskProgress?.successful || 0"></div>
                                            <div class="stat-label">Успішно</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-box">
                                            <div class="stat-icon text-warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </div>
                                            <div class="stat-number" x-text="taskProgress?.errors?.length || 0"></div>
                                            <div class="stat-label">Помилки</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-box">
                                            <div class="stat-icon text-info">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-number" x-text="`${taskProgress?.percentage || 0}%`"></div>
                                            <div class="stat-label">Завершено</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="current-item" x-show="taskProgress?.current_item">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    <span x-text="`Обробляється: ${taskProgress?.current_item}`"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Help Tab -->
                <div x-show="currentTab === 'help'">
                    <div class="py-4">
                        <h1 class="mb-4">
                            <i class="fas fa-graduation-cap me-3"></i>
                            Повна інструкція користування
                        </h1>
                        
                        <div class="help-section">
                            <div class="help-title">
                                <i class="fas fa-info-circle"></i>
                                Що робить система
                            </div>
                            <div class="help-content">
                                <p>Система автоматично оновлює ціни та знижки для товарів у вашому Shopify магазині. У Shopify є два типи цін:</p>
                                <ul>
                                    <li><strong>Price (реальна ціна)</strong> - це та ціна, яку платить покупець</li>
                                    <li><strong>Compare at price (порівняльна ціна)</strong> - це перекреслена ціна, яка показує "від скільки було"</li>
                                </ul>
                                <p>Знижка розраховується як різниця між цими цінами: (Compare at price - Price) / Compare at price × 100%</p>
                            </div>
                        </div>

                        <div class="help-section">
                            <div class="help-title">
                                <i class="fas fa-chess"></i>
                                Детальний опис стратегій
                            </div>
                            <div class="help-content">
                                <h6><i class="fas fa-arrow-up text-success me-2"></i>1. Збільшити знижку</h6>
                                <ul>
                                    <li><strong>Що робить:</strong> Підвищує тільки порівняльну ціну (перекреслену)</li>
                                    <li><strong>Реальна ціна:</strong> Залишається без змін - ваш прибуток не змінюється</li>
                                    <li><strong>Ефект:</strong> Знижка виглядає більшою, товар стає привабливішим</li>
                                    <li><strong>Коли використовувати:</strong> Коли хочете збільшити конверсію без втрати прибутку</li>
                                </ul>
                                <div class="example-box">
                                    <strong>Приклад:</strong> Збільшення на 20%<br>
                                    Було: $100 (реальна), $120 (порівняльна) = 16.7% знижка<br>
                                    Стало: $100 (реальна), $144 (порівняльна) = 30.6% знижка<br>
                                    <span class="text-success">✓ Знижка виросла з 16.7% до 30.6%</span>
                                </div>

                                <h6><i class="fas fa-arrow-down text-info me-2"></i>2. Зменшити ціну</h6>
                                <ul>
                                    <li><strong>Що робить:</strong> Знижує реальну ціну товару</li>
                                    <li><strong>Порівняльна ціна:</strong> Залишається або створюється автоматично</li>
                                    <li><strong>Ефект:</strong> Покупець платить менше + знижка стає більшою</li>
                                    <li><strong>Коли використовувати:</strong> Для розпродажів, акцій, очищення складу</li>
                                </ul>
                                <div class="example-box">
                                    <strong>Приклад:</strong> Зниження на 15%<br>
                                    Було: $100 (реальна), $120 (порівняльна) = 16.7% знижка<br>
                                    Стало: $85 (реальна), $120 (порівняльна) = 29.2% знижка<br>
                                    <span class="text-success">✓ Покупець економить $15 + знижка виросла до 29.2%</span>
                                </div>

                                <h6><i class="fas fa-exchange-alt text-warning me-2"></i>3. Змінити обидві ціни</h6>
                                <ul>
                                    <li><strong>Що робить:</strong> Одночасно змінює реальну та порівняльну ціну</li>
                                    <li><strong>Алгоритм:</strong> Порівняльна ціна змінюється в 1.5 рази більше</li>
                                    <li><strong>Ефект:</strong> Максимальна гнучкість у ціноутворенні</li>
                                    <li><strong>Коли використовувати:</strong> Для складних маркетингових стратегій</li>
                                </ul>
                                <div class="example-box">
                                    <strong>Приклад:</strong> Збільшення на 10%<br>
                                    Було: $100 (реальна), $120 (порівняльна) = 16.7% знижка<br>
                                    Стало: $110 (реальна), $138 (порівняльна) = 20.3% знижка<br>
                                    <span class="text-success">✓ Ціна виросла, але знижка також збільшилась</span>
                                </div>

                                <h6><i class="fas fa-bullseye text-danger me-2"></i>4. Встановити точну знижку</h6>
                                <ul>
                                    <li><strong>Що робить:</strong> Розраховує порівняльну ціну для досягнення цільової знижки</li>
                                    <li><strong>Формула:</strong> Порівняльна ціна = Реальна ціна ÷ (1 - знижка ÷ 100)</li>
                                    <li><strong>Ефект:</strong> Точний відсоток знижки як у маркетингу</li>
                                    <li><strong>Коли використовувати:</strong> Для кампаній типу "30% знижка на все"</li>
                                </ul>
                                <div class="example-box">
                                    <strong>Приклад:</strong> Встановити знижку 30%<br>
                                    Поточна ціна: $80<br>
                                    Стало: $80 (реальна), $114.29 (порівняльна) = точно 30% знижка<br>
                                    <span class="text-success">✓ Гарантована точна знижка 30%</span>
                                </div>
                            </div>
                        </div>

                        <div class="help-section">
                            <div class="help-title">
                                <i class="fas fa-filter"></i>
                                Фільтрація товарів
                            </div>
                            <div class="help-content">
                                <h6>Типи фільтрів:</h6>
                                <ul>
                                    <li><strong>Всі товари:</strong> Застосовує зміни до всього асортименту в магазині</li>
                                    <li><strong>За типом товару:</strong> Фільтрує по полю "Product Type" (наприклад: "T-Shirt", "Shoes", "Accessories")</li>
                                    <li><strong>За виробником:</strong> Фільтрує по полю "Vendor" (наприклад: "Nike", "Adidas", "Apple")</li>
                                </ul>

                                <h6>Як знайти правильні значення:</h6>
                                <div class="example-box">
                                    1. Перейдіть в адмін Shopify → Products<br>
                                    2. Відкрийте будь-який товар<br>
                                    3. Подивіться поля "Product type" та "Vendor"<br>
                                    4. Використовуйте точні назви (з урахуванням регістру)
                                </div>

                                <h6>Обмеження кількості:</h6>
                                <ul>
                                    <li><strong>Порожнє поле:</strong> Обробляє всі знайдені товари</li>
                                    <li><strong>Число (наприклад 10):</strong> Обробляє тільки перші 10 товарів</li>
                                    <li><strong>Рекомендація:</strong> Для першого тесту встановіть 5-10 товарів</li>
                                </ul>
                            </div>
                        </div>

                        <div class="help-section">
                            <div class="help-title">
                                <i class="fas fa-shield-alt"></i>
                                Безпека та рекомендації
                            </div>
                            <div class="help-content">
                                <h6>Обов'язкові кроки перед використанням:</h6>
                                <ul>
                                    <li><strong>1. Тестування:</strong> Завжди натискайте "Показати приклад" перед застосуванням</li>
                                    <li><strong>2. Малі партії:</strong> Почніть з 5-10 товарів для перевірки результату</li>
                                    <li><strong>3. Резервна копія:</strong> Запишіть поточні ціни важливих товарів</li>
                                    <li><strong>4. Перевірка:</strong> Після застосування перевірте кілька товарів в магазині</li>
                                </ul>

                                <h6>Що потрібно знати:</h6>
                                <ul>
                                    <li><strong>Миттєвість:</strong> Зміни з'являються в магазині одразу після обробки</li>
                                    <li><strong>Всі варіанти:</strong> Система обробляє всі варіанти товару (розміри, кольори)</li>
                                    <li><strong>Валюти:</strong> Працює з будь-якою валютою вашого магазину</li>
                                    <li><strong>Обмеження API:</strong> Система автоматично регулює швидкість запитів</li>
                                </ul>

                                <h6>Що робити, якщо щось пішло не так:</h6>
                                <ul>
                                    <li>Система зберігає інформацію про всі зміни</li>
                                    <li>У Shopify Admin можна вручну повернути старі ціни</li>
                                    <li>Якщо помилок багато - зупиніть процес і перевірте налаштування</li>
                                    <li>Зверніться до служби підтримки Shopify у критичних випадках</li>
                                </ul>
                            </div>
                        </div>

                        <div class="help-section">
                            <div class="help-title">
                                <i class="fas fa-lightbulb"></i>
                                Практичні поради та кейси
                            </div>
                            <div class="help-content">
                                <h6>Кейс 1: Збільшення конверсії без втрат</h6>
                                <ul>
                                    <li><strong>Мета:</strong> Зробити товари привабливішими, не втрачаючи прибуток</li>
                                    <li><strong>Стратегія:</strong> "Збільшити знижку" на 15-25%</li>
                                    <li><strong>Результат:</strong> Знижка з 10% стає 25-30%, покупці бачать кращу пропозицію</li>
                                </ul>

                                <h6>Кейс 2: Розпродаж старих товарів</h6>
                                <ul>
                                    <li><strong>Мета:</strong> Швидко розпродати товари з складу</li>
                                    <li><strong>Стратегія:</strong> "Зменшити ціну" на 20-40%</li>
                                    <li><strong>Результат:</strong> Реальні знижки мотивують до покупки</li>
                                </ul>

                                <h6>Кейс 3: Маркетингова акція "50% знижка"</h6>
                                <ul>
                                    <li><strong>Мета:</strong> Запустити рекламну кампанію з точною знижкою</li>
                                    <li><strong>Стратегія:</strong> "Встановити точну знижку" 50%</li>
                                    <li><strong>Результат:</strong> Всі товари мають рівно 50% знижку</li>
                                </ul>

                                <h6>Поради по продуктивності:</h6>
                                <ul>
                                    <li>Обробляйте товари частинами по 50-100 штук</li>
                                    <li>Не запускайте кілька процесів одночасно</li>
                                    <li>Робіть оновлення в години низької активності магазину</li>
                                    <li>Стежте за прогресом - якщо багато помилок, зупиніться</li>
                                </ul>

                                <h6>Аналітика після змін:</h6>
                                <ul>
                                    <li>Порівняйте конверсію до та після змін</li>
                                    <li>Відстежуйте середній чек та кількість продажів</li>
                                    <li>Аналізуйте поведінку покупців з новими цінами</li>
                                    <li>Коригуйте стратегію на основі результатів</li>
                                </ul>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Важливо:</strong> Ця система є потужним інструментом для керування цінами. 
                            Використовуйте її обережно та завжди тестуйте на малій кількості товарів перед масовими змінами.
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        function discountApp() {
            return {
                currentTab: 'main',
                form: {
                    strategy: '',
                    value: 10,
                    target_discount: 25,
                    filter_type: 'all',
                    filter_value: '',
                    limit_products: null
                },
                preview: null,
                taskProgress: null,
                isProcessing: false,

                selectStrategy(strategy) {
                    this.form.strategy = strategy;
                    this.preview = null;
                    console.log('Обрана стратегія:', strategy);
                },

                getHelpText() {
                    switch(this.form.strategy) {
                        case 'increase_compare_only':
                            return 'На скільки відсотків збільшити порівняльну ціну (рекомендується 15-30%)';
                        case 'decrease_price_only':
                            return 'На скільки відсотків зменшити реальну ціну (рекомендується 10-25%)';
                        case 'both_directions':
                            return 'Базовий відсоток для зміни обох цін (система автоматично розрахує пропорції)';
                        default:
                            return '';
                    }
                },

                isFormValid() {
                    if (!this.form.strategy) return false;
                    
                    if (this.form.filter_type !== 'all' && !this.form.filter_value.trim()) {
                        return false;
                    }
                    
                    if (this.form.strategy === 'set_discount_percentage') {
                        return this.form.target_discount > 0 && this.form.target_discount < 100;
                    } else {
                        return this.form.value > 0;
                    }
                },

                async showPreview() {
                    try {
                        const formData = new FormData();
                        formData.append('strategy', this.form.strategy);
                        
                        if (this.form.strategy === 'set_discount_percentage') {
                            formData.append('value', '0');
                            formData.append('target_discount', this.form.target_discount);
                        } else {
                            formData.append('value', this.form.value);
                        }
                        
                        formData.append('filter_type', this.form.filter_type);
                        formData.append('filter_value', this.form.filter_value);

                        const response = await fetch('/preview-changes', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            this.showAlert('Помилка: ' + data.error, 'danger');
                            this.preview = null;
                        } else {
                            this.preview = data;
                            this.showAlert('✅ Приклад успішно створено!', 'success');
                        }
                    } catch (error) {
                        this.showAlert('❌ Помилка створення прикладу: ' + error.message, 'danger');
                    }
                },

                async submitUpdate() {
                    this.isProcessing = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('strategy', this.form.strategy);
                        
                        if (this.form.strategy === 'set_discount_percentage') {
                            formData.append('value', '0');
                            formData.append('target_discount', this.form.target_discount);
                        } else {
                            formData.append('value', this.form.value);
                        }
                        
                        formData.append('filter_type', this.form.filter_type);
                        formData.append('filter_value', this.form.filter_value);
                        if (this.form.limit_products) {
                            formData.append('limit_products', this.form.limit_products);
                        }

                        const response = await fetch('/update-prices', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        
                        if (data.task_id) {
                            this.startProgressTracking(data.task_id);
                            this.showAlert('🚀 Оновлення знижок розпочато!', 'info');
                        }
                    } catch (error) {
                        this.showAlert('❌ Помилка запуску: ' + error.message, 'danger');
                        this.isProcessing = false;
                    }
                },

                startProgressTracking(taskId) {
                    const checkProgress = async () => {
                        try {
                            const response = await fetch(`/progress/${taskId}`);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            
                            const data = await response.json();
                            this.taskProgress = data;
                            
                            if (data.status === 'completed') {
                                this.isProcessing = false;
                                const stats = data.final_stats || {};
                                this.showAlert(
                                    `🎉 Оновлення завершено!\n📊 Оброблено: ${stats.total_processed || 0}\n✅ Успішно: ${stats.successful_updates || 0}\n❌ Помилки: ${stats.errors_count || 0}`, 
                                    'success'
                                );
                                setTimeout(() => {
                                    this.taskProgress = null;
                                }, 10000);
                            } else if (data.status === 'failed') {
                                this.isProcessing = false;
                                this.showAlert('❌ Помилка оновлення: ' + (data.error || 'Невідома помилка'), 'danger');
                            } else {
                                setTimeout(checkProgress, 2000);
                            }
                        } catch (error) {
                            console.error('Помилка отримання прогресу:', error);
                            setTimeout(checkProgress, 5000);
                        }
                    };
                    
                    checkProgress();
                },

                showAlert(message, type = 'info') {
                    const alert = document.createElement('div');
                    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 450px; box-shadow: 0 8px 24px rgba(0,0,0,0.5);';
                    alert.innerHTML = `
                        <div style="white-space: pre-line;">${message}</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" style="filter: brightness(0) invert(1);"></button>
                    `;
                    document.body.appendChild(alert);
                    
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 8000);
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
